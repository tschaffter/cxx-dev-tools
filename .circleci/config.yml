version: 2.1

commands:
  checkout-repository:
    description: Checkout this repository and its submodules
    steps:
      - checkout
      - run: git submodule sync
      - run: git submodule update --init
  export-cxx-dev-tools:
    description: Add cxx dev tools to PATH
    steps:
      - run:
          name: Add cxx dev tools to PATH
          command: |
            . export.sh
            echo 'export PATH='$PATH >> $BASH_ENV
            echo 'export CXX_DEV_TOOLS_PATH='$CXX_DEV_TOOLS_PATH >> $BASH_ENV
  run-cmake-lint:
    description: Run cmake lint
    steps:
      - run:
          name: Run cmake lint
          command: run-cmake-lint.sh "$(< .cmake-format-files)"
  test-cmake-lint:
      description: Test cmake-format
      steps:
      - run:
          name: cmake-format-check.sh returns 0 on valid cmake sample
          command: run-cmake-format-check.sh
            cmake/format/samples/valid-format.cmake
      - run:
          name: cmake-format-check.sh returns 1 on invalid cmake sample
          command: run-cmake-format-check.sh
            cmake/format/samples/invalid-format.hpp && exit 1 || exit 0
  test-clang-format:
    description: Test clang-format
    steps:
      - run:
          name: clang-format-check.sh returns 0 on valid header samples
          command: run-clang-format-check.sh
            clang/format/samples/valid-*.hpp
      - run:
          name: clang-format-check.sh returns 1 on invalid header samples
          command: run-clang-format-check.sh
            clang/format/samples/invalid-*.hpp && exit 1 || exit 0


jobs:
  lint:
    docker:
      - image: tschaffter/cxx-ci
    steps:
      - checkout-repository
      - export-cxx-dev-tools
      - run-cmake-lint
  test:
    docker:
      - image: tschaffter/cxx-ci
    steps:
      - checkout-repository
      - export-cxx-dev-tools
      - test-cmake-format
      - test-clang-format


workflows:
  version: 2
  test:
    jobs:
      - test:
          filters:
            branches:
              only:
                - master
                - develop
                - /rc-.*/
      - lint:
          requires:
            - test
          filters:
            branches:
              only:
                - master
                - develop
                - /rc-.*/
